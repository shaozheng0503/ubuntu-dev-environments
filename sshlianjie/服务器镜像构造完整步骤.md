# 服务器 SSH 连接后构造镜像完整步骤

## 1 服务器连接准备

### 1.1 服务器信息确认
在开始构造镜像之前，需要确认以下服务器信息：
- **服务器 1**: 43.135.68.39
- **服务器 2**: 43.132.192.253
- **用户名**: root
- **密码**: 8pA!5DRAq#
- **端口**: 22

### 1.2 连接方式选择
根据您的操作系统选择合适的连接方式：

**Windows 用户**：
```cmd
# 使用批处理脚本连接
ssh_connect.bat

# 或快速连接指定服务器
quick_connect.bat 1  # 连接服务器 1
quick_connect.bat 2  # 连接服务器 2
```

**Linux/macOS 用户**：
```bash
# 交互式连接
chmod +x ssh_connect.sh
./ssh_connect.sh

# 直接连接指定服务器
chmod +x ssh_direct.sh
./ssh_direct.sh 1  # 连接服务器 1
./ssh_direct.sh 2  # 连接服务器 2
```

**PowerShell 用户**：
```powershell
.\ssh_connect.ps1
```

## 2 服务器环境检查

### 2.1 系统信息确认
连接成功后，首先检查服务器环境：
```bash
# 检查系统版本
cat /etc/os-release

# 检查内存和存储空间
free -h
df -h

# 检查 Docker 是否已安装
docker --version

# 检查 Docker 服务状态
systemctl status docker
```

### 2.2 Docker 环境准备
如果服务器未安装 Docker，需要先安装：
```bash
# 更新包列表
apt update

# 安装必要的依赖
apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

# 添加 Docker 官方 GPG 密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# 添加 Docker 仓库
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker
apt update
apt install -y docker-ce docker-ce-cli containerd.io

# 启动 Docker 服务
systemctl start docker
systemctl enable docker
```

## 3 项目文件上传

### 3.1 本地文件准备
在本地计算机上，确保以下文件已准备好：
- `dockerfilemain` - Docker 镜像构建文件
- `init/init.sh` - 初始化脚本
- `config/supervisord.conf` - Supervisor 配置文件
- `config/settings.json` - VS Code 配置文件

### 3.2 文件上传到服务器
使用 SCP 命令将文件上传到服务器：
```bash
# 创建项目目录
ssh root@43.135.68.39 "mkdir -p /root/docker-project"

# 上传 Dockerfile
scp dockerfilemain root@43.135.68.39:/root/docker-project/Dockerfile

# 上传配置文件
scp -r config/ root@43.135.68.39:/root/docker-project/
scp -r init/ root@43.135.68.39:/root/docker-project/
```

## 4 镜像构建过程

### 4.1 进入项目目录
```bash
# SSH 连接到服务器
ssh root@43.135.68.39

# 进入项目目录
cd /root/docker-project
```

### 4.2 构建 Docker 镜像
```bash
# 构建镜像（设置 SSH 密码）
docker build -t my-jupyter-cuda:latest --build-arg SSH_PASSWORD=your_password .

# 或者使用默认密码
docker build -t my-jupyter-cuda:latest .
```

### 4.3 构建过程说明
构建过程将执行以下步骤：

**基础镜像设置**：使用 NVIDIA CUDA 11.8 基础镜像，包含 CUDA 和 cuDNN 支持。

**系统环境配置**：配置国内镜像源（阿里云），更新系统包并安装必要工具。

**Python 环境安装**：安装 Miniconda3，配置清华镜像源，升级 Python 到 3.12 版本。

**Node.js 环境**：安装 Node.js 20.x 版本，为 VS Code Server 提供支持。

**JupyterLab 安装**：安装 JupyterLab 4.4.4 及相关插件，包括代码补全、数学公式支持等。

**PyTorch 安装**：安装 PyTorch 2.7.0，适配 CUDA 11.8 环境。

**开发工具配置**：安装 VS Code Server，配置无密码访问。

**服务管理**：使用 Supervisor 管理 SSH、VS Code Server 和 JupyterLab 服务。

## 5 容器运行配置

### 5.1 启动容器
```bash
# 运行容器
docker run -d \
  --name jupyter-cuda-container \
  --gpus all \
  -p 22:22 \
  -p 62661:62661 \
  -p 8888:8888 \
  -v /path/to/your/data:/root/data \
  my-jupyter-cuda:latest
```

### 5.2 端口说明
- **22**: SSH 连接端口
- **62661**: VS Code Server 端口
- **8888**: JupyterLab 端口

### 5.3 数据卷挂载
```bash
# 创建数据目录
mkdir -p /root/data

# 运行容器时挂载数据卷
docker run -d \
  --name jupyter-cuda-container \
  --gpus all \
  -p 22:22 \
  -p 62661:62661 \
  -p 8888:8888 \
  -v /root/data:/root/data \
  my-jupyter-cuda:latest
```

## 6 服务访问验证

### 6.1 SSH 连接测试
```bash
# 从本地连接到容器
ssh -p 22 root@服务器IP
# 密码：your_password 或默认密码
```

### 6.2 VS Code Server 访问
在浏览器中访问：
```
http://服务器IP:62661
```

### 6.3 JupyterLab 访问
在浏览器中访问：
```
http://服务器IP:8888
```

## 7 容器管理命令

### 7.1 容器状态检查
```bash
# 查看容器运行状态
docker ps

# 查看容器日志
docker logs jupyter-cuda-container

# 进入容器内部
docker exec -it jupyter-cuda-container bash
```

### 7.2 容器停止和重启
```bash
# 停止容器
docker stop jupyter-cuda-container

# 启动容器
docker start jupyter-cuda-container

# 重启容器
docker restart jupyter-cuda-container
```

### 7.3 容器删除
```bash
# 停止并删除容器
docker stop jupyter-cuda-container
docker rm jupyter-cuda-container

# 删除镜像
docker rmi my-jupyter-cuda:latest
```

## 8 故障排除

### 8.1 构建失败处理
如果镜像构建失败，检查以下问题：
- 网络连接是否正常
- 服务器存储空间是否充足
- Docker 服务是否正常运行
- 基础镜像是否可访问

### 8.2 容器启动问题
如果容器无法正常启动：
```bash
# 查看详细日志
docker logs jupyter-cuda-container

# 检查端口占用
netstat -tlnp | grep -E ':(22|62661|8888)'

# 检查 GPU 驱动
nvidia-smi
```

### 8.3 服务访问问题
如果无法访问服务：
- 检查防火墙设置
- 确认端口映射正确
- 验证容器内部服务状态

## 9 性能优化建议

### 9.1 资源分配
根据服务器配置调整资源分配：
```bash
# 限制内存使用
docker run -d \
  --name jupyter-cuda-container \
  --gpus all \
  --memory=8g \
  --cpus=4 \
  -p 22:22 \
  -p 62661:62661 \
  -p 8888:8888 \
  my-jupyter-cuda:latest
```

### 9.2 存储优化
使用 SSD 存储提高性能，定期清理无用镜像和容器：
```bash
# 清理未使用的镜像
docker image prune -a

# 清理未使用的容器
docker container prune

# 清理未使用的数据卷
docker volume prune
```

通过以上完整步骤，您可以在服务器 SSH 连接后成功构造并运行包含 JupyterLab、VS Code Server 和 CUDA 支持的 Docker 镜像，为深度学习开发提供完整的开发环境。 