# TensorFlow 2.19 开发环境启动脚本详细说明

## 1. 概述

本文档详细讲解了 TensorFlow 2.19 开发环境的启动脚本系统，包括容器初始化、服务配置和进程管理。该环境基于 Ubuntu 22.04 + CUDA 12.9，集成了 TensorFlow 2.19、JupyterLab、VSCode Server 和 SSH 服务。

## 2. 文件结构

```
transflow2.19/
├── init/
│   └── init.sh              # 容器初始化脚本
├── config/
│   ├── supervisord.conf     # 进程管理配置
│   └── settings.json        # VSCode 配置
└── TF219                    # Dockerfile（位于上级目录）
```

## 3. 核心组件详解

### 3.1 容器初始化脚本 (init/init.sh)

#### 3.1.1 脚本概述

`init.sh` 是容器启动时执行的第一个脚本，负责配置系统环境、设置服务参数和启动必要的服务。

#### 3.1.2 详细分析

```bash
#!/bin/bash
set -e  # 遇到错误立即退出
```

**设置 root 密码**
```bash
echo "root:${SSH_PASSWORD}" | chpasswd
```
- 使用环境变量 `SSH_PASSWORD` 设置 root 用户密码
- 默认密码为 `123456`，可通过构建参数自定义

**配置 code-server**
```bash
CONFIG_DIR="/root/.config/code-server"
CONFIG_FILE="${CONFIG_DIR}/config.yaml"
mkdir -p "${CONFIG_DIR}"

cat <<EOF > "${CONFIG_FILE}"
bind-addr: 0.0.0.0:62661
auth: none
cert: false
EOF
```

**配置说明**：
- `bind-addr: 0.0.0.0:62661` - 监听所有网络接口的 62661 端口
- `auth: none` - 禁用身份验证，允许无密码访问
- `cert: false` - 禁用 HTTPS 证书验证

**配置 Jupyter Server**
```bash
mkdir -p /root/.jupyter
cat <<EOF > /root/.jupyter/jupyter_server_config.py
c.ServerApp.password = u''
c.ServerApp.token = ''
c.ServerApp.allow_origin = '*'
c.ServerApp.disable_check_xsrf = True
c.ServerApp.terminado_settings = {'shell_command': ['/bin/bash']}
EOF
```

**配置说明**：
- `c.ServerApp.password = u''` - 清空密码，允许无密码访问
- `c.ServerApp.token = ''` - 清空访问令牌
- `c.ServerApp.allow_origin = '*'` - 允许所有来源的跨域请求
- `c.ServerApp.disable_check_xsrf = True` - 禁用 XSRF 检查
- `c.ServerApp.terminado_settings` - 设置终端使用 bash

**配置 VSCode 设置**
```bash
mkdir -p /root/.local/share/code-server/User
mv /tmp/settings.json /root/.local/share/code-server/User/settings.json
```

### 3.2 进程管理配置 (config/supervisord.conf)

#### 3.2.1 Supervisord 概述

Supervisord 是一个进程管理工具，用于在容器中管理多个服务进程，确保服务稳定运行和自动重启。

#### 3.2.2 配置详解

**全局配置**
```ini
[supervisord]
nodaemon=true
```
- `nodaemon=true` - 在前台运行，适合容器环境

**SSH 服务配置**
```ini
[program:sshd]
command=/usr/sbin/sshd -D
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
```

**配置说明**：
- `command=/usr/sbin/sshd -D` - 启动 SSH 守护进程
- `autostart=true` - 容器启动时自动启动
- `autorestart=true` - 进程异常退出时自动重启
- `stdout_logfile=/dev/stdout` - 标准输出重定向到容器日志
- `stderr_logfile=/dev/stderr` - 错误输出重定向到容器日志

**VSCode Server 配置**
```ini
[program:code-server]
command=/usr/bin/code-server --bind-addr 0.0.0.0:62661
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
```

**JupyterLab 配置**
```ini
[program:jupyterlab]
command=/opt/miniconda3/bin/jupyter-lab --ip=0.0.0.0 --port=8888 --allow-root --no-browser
directory=/root
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
environment=HOME="/root",PATH="/opt/miniconda3/bin:%(ENV_PATH)s"
```

**配置说明**：
- `command` - 启动 JupyterLab 服务
- `directory=/root` - 设置工作目录为 root 用户目录
- `environment` - 设置环境变量，确保 Python 路径正确

### 3.3 VSCode 配置 (config/settings.json)

#### 3.3.1 配置详解

```json
{
    "python.analysis.diagnosticSeverityOverrides": {},
    "python.defaultInterpreterPath": "/opt/miniconda3/bin/python",
    "files.exclude": {
        "**/.*": true
    },
    "files.associations": {
        "*.py": "python"
    },
    "terminal.integrated.defaultProfile.linux": "bash",
    "terminal.integrated.profiles.linux": {
        "bash": {
            "path": "/bin/bash",
            "args": []
        }
    }
}
```

**配置说明**：
- `python.defaultInterpreterPath` - 设置默认 Python 解释器路径
- `files.exclude` - 隐藏以点开头的文件（如 .git）
- `files.associations` - 设置文件类型关联
- `terminal.integrated` - 配置集成终端使用 bash

## 4. 启动流程

### 4.1 容器启动顺序

1. **Docker 容器启动** - 执行 `CMD ["/init/init.sh"]`
2. **初始化脚本执行** - 配置系统环境和服务参数
3. **Supervisord 启动** - 管理所有服务进程
4. **服务启动** - SSH、VSCode Server、JupyterLab 并行启动

### 4.2 服务端口映射

| 服务 | 容器端口 | 主机端口 | 说明 |
|------|----------|----------|------|
| SSH | 22 | 2222 | SSH 远程访问 |
| JupyterLab | 8888 | 8888 | Web 开发环境 |
| VSCode Server | 62661 | 62661 | 在线代码编辑器 |

## 5. 环境特性

### 5.1 技术栈

- **基础系统**: Ubuntu 22.04 + CUDA 12.9
- **Python 环境**: Python 3.12 + Miniconda
- **深度学习**: TensorFlow 2.19
- **开发工具**: JupyterLab 4.4.4 + VSCode Server
- **进程管理**: Supervisord
- **远程访问**: SSH

### 5.2 安全配置

- **无密码访问**: JupyterLab 和 VSCode Server 配置为无密码访问
- **SSH 认证**: 支持密码认证，默认密码 123456
- **网络隔离**: 容器化部署，网络隔离
- **权限控制**: 以 root 用户运行，适合开发环境

## 6. 使用指南

### 6.1 构建镜像

```bash
docker build -f 0722kafaji2204/TF219 -t tensorflow219:latest .
```

### 6.2 运行容器

```bash
docker run -d \
  --name tf219-dev \
  --gpus all \
  -p 2222:22 \
  -p 8888:8888 \
  -p 62661:62661 \
  tensorflow219:latest
```

### 6.3 访问服务

- **SSH**: `ssh -p 2222 root@localhost` (密码: 123456)
- **JupyterLab**: http://localhost:8888/lab
- **VSCode**: http://localhost:62661

### 6.4 服务管理

```bash
# 查看服务状态
docker exec tf219-dev supervisorctl status

# 重启特定服务
docker exec tf219-dev supervisorctl restart jupyterlab

# 查看服务日志
docker exec tf219-dev supervisorctl tail -f sshd
```

## 7. 故障排除

### 7.1 常见问题

**服务无法启动**
- 检查端口是否被占用
- 验证 GPU 驱动是否正确安装
- 查看容器日志：`docker logs tf219-dev`

**无法访问 Web 服务**
- 确认端口映射正确
- 检查防火墙设置
- 验证服务状态：`docker exec tf219-dev supervisorctl status`

**TensorFlow GPU 不可用**
- 确认 CUDA 环境变量设置正确
- 检查 GPU 驱动版本兼容性
- 运行 GPU 测试：`python -c "import tensorflow as tf; print(tf.config.list_physical_devices('GPU'))"`

### 7.2 日志查看

```bash
# 查看容器日志
docker logs -f tf219-dev

# 查看特定服务日志
docker exec tf219-dev supervisorctl tail -f jupyterlab

# 查看系统日志
docker exec tf219-dev journalctl -f
```

## 8. 自定义配置

### 8.1 修改 SSH 密码

```bash
docker build \
  --build-arg SSH_PASSWORD=your_password \
  -f 0722kafaji2204/TF219 \
  -t tensorflow219:custom .
```

### 8.2 添加自定义包

在 Dockerfile 中添加：
```dockerfile
RUN /opt/miniconda3/bin/pip install your_package_name
```

### 8.3 修改服务配置

编辑 `config/supervisord.conf` 文件，调整服务参数。

## 9. 性能优化

### 9.1 资源限制

```bash
docker run -d \
  --name tf219-dev \
  --gpus all \
  --memory=8g \
  --cpus=4 \
  -p 2222:22 \
  -p 8888:8888 \
  -p 62661:62661 \
  tensorflow219:latest
```

### 9.2 数据持久化

```bash
docker run -d \
  --name tf219-dev \
  --gpus all \
  -v /host/data:/root/data \
  -p 2222:22 \
  -p 8888:8888 \
  -p 62661:62661 \
  tensorflow219:latest
```

## 10. 总结

TensorFlow 2.19 开发环境启动脚本提供了一个完整的容器化开发解决方案，通过 Supervisord 实现了多服务的统一管理，确保了开发环境的稳定性和可用性。该环境特别适合深度学习项目的开发和部署，提供了从代码编写到模型训练的完整工具链。 